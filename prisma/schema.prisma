// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId         String?        @map("role_id") @db.Uuid
  addressId      String?        @map("address_id") @db.Uuid
  numberDocument String?        @unique @map("number_document")
  typeDocument   TypeDocument   @default(DNI) @map("type_document")
  numberCard     String?        @unique @map("number_card")
  name           String         @db.VarChar
  lastName       String         @map("last_name") @db.VarChar
  email          String?
  emailValidated Boolean        @default(false) @map("email_validated")
  image          String?        @db.VarChar
  password       String         @db.VarChar
  phone          Json
  codeValidation String?        @unique @map("code_validation")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at")
  createdBy      String         @map("created_by")
  updatedBy      String?        @map("updated_by")
  role           Role?          @relation(fields: [roleId], references: [id])
  staff          Staff?
  student        Student?
  teacher        Teacher?
  tutor          Tutor?
  authSessions   AuthSession[]
  accessRecords  AccessRecord[]
  address        Address?       @relation(fields: [addressId], references: [id])

  @@map("users")
}

model Branch {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  addressId         String            @map("address_id") @db.Uuid
  name              String            @unique @db.VarChar
  phone             String[]          @db.VarChar
  active            Boolean           @default(true)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")
  createdBy         String            @map("created_by")
  updatedBy         String?           @map("updated_by")
  rooms             Room[]
  staffs            Staff[]
  teachers          Teacher[]
  branchSpecialties BranchSpecialty[]
  accessRecords     AccessRecord[]
  address           Address           @relation(fields: [addressId], references: [id])

  @@map("branches")
}

model Staff {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @unique @map("user_id") @db.Uuid
  active     Boolean  @default(true)
  superStaff Boolean  @default(false) @map("super_staff")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")
  createdBy  String   @map("created_by")
  updatedBy  String?  @map("updated_by")
  user       User     @relation(fields: [userId], references: [id])
  branches   Branch[]

  @@map("staffs")
}

model Address {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  city      String   @db.VarChar
  zone      String   @db.VarChar
  detail    String   @db.VarChar
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  createdBy String   @map("created_by")
  updatedBy String?  @map("updated_by")
  users     User[]
  branches  Branch[]

  @@unique([city, zone, detail])
  @@map("addresses")
}

model AuthSession {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar
  ipAddress String   @map("ip_address") @db.VarChar
  userAgent String   @map("user_agent") @db.VarChar
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  createdBy String   @map("created_by")
  updatedBy String?  @map("updated_by")
  revokedAt DateTime @updatedAt @map("revoked_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("auth_sessions")
}

model Permission {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action    TypeAction
  subject   String
  active    Boolean    @default(true)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @default(now()) @updatedAt @map("updated_at")
  createdBy String     @map("created_by")
  updatedBy String?    @map("updated_by")
  roles     Role[]

  @@unique([action, subject])
  @@map("permissions")
}

model Role {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String       @unique @db.VarChar
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")
  createdBy   String       @map("created_by")
  updatedBy   String?      @map("updated_by")
  permissions Permission[]
  users       User[]

  @@map("roles")
}

model Student {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String          @unique @map("user_id") @db.Uuid
  schoolId            String?         @map("school_id") @db.Uuid
  code                String          @unique
  birthdate           DateTime
  gender              Gender
  grade               Int?            @db.Integer
  educationLevel      EducationLevel? @map("education_level")
  active              Boolean         @default(true)
  sessionTrackings    Json?           @map("session_trackingss") @db.Json
  weeklyPlannings     Json?           @map("weekly_plannings") @db.Json
  evaluationPlannings Json?           @map("evaluation_plannings") @db.Json
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @default(now()) @updatedAt @map("updated_at")
  createdBy           String          @map("created_by")
  updatedBy           String?         @map("updated_by")
  user                User            @relation(fields: [userId], references: [id])
  inscriptions        Inscription[]
  tutors              Tutor[]
  school              School?         @relation(fields: [schoolId], references: [id])

  @@map("students")
}

model School {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String    @unique @db.VarChar
  students  Student[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  createdBy String    @map("created_by")
  updatedBy String?   @map("updated_by")

  @@map("schools")
}

model Tutor {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @unique @map("user_id") @db.Uuid
  active    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  createdBy String    @map("created_by")
  updatedBy String?   @map("updated_by")
  user      User      @relation(fields: [userId], references: [id])
  students  Student[]

  @@map("tutors")
}

model Teacher {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String         @unique @map("user_id") @db.Uuid
  major          String         @db.VarChar
  academicStatus AcademicStatus @map("academic_status")
  startJob       DateTime       @default(now()) @map("start_job")
  active         Boolean        @default(true)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at")
  createdBy      String         @map("created_by")
  updatedBy      String?        @map("updated_by")
  user           User           @relation(fields: [userId], references: [id])
  mainRooms      Room[]         @relation("room_teacher")
  assistedRooms  Room[]         @relation("room_assistant")
  branches       Branch[]

  @@map("teachers")
}

model Specialty {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String            @unique @db.VarChar
  active            Boolean           @default(true)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")
  createdBy         String            @map("created_by")
  updatedBy         String?           @map("updated_by")
  branchSpecialties BranchSpecialty[]
  rooms             Room[]

  @@map("specialties")
}

model BranchSpecialty {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchId             String    @map("branch_id") @db.Uuid
  specialtyId          String    @map("specialty_id") @db.Uuid
  estimatedSessionCost Float     @default(0.00) @map("estimated_session_cost")
  numberSessions       Int       @default(1) @map("number_sessions")
  active               Boolean   @default(true)
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at")
  createdBy            String    @map("created_by")
  updatedBy            String?   @map("updated_by")
  branch               Branch    @relation(fields: [branchId], references: [id])
  specialty            Specialty @relation(fields: [specialtyId], references: [id])

  @@unique([branchId, specialtyId])
  @@map("branch_specialties")
}

model Room {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchId        String           @map("branch_id") @db.Uuid
  teacherId       String           @map("teacher_id") @db.Uuid
  assistantId     String           @map("assistant_id") @db.Uuid
  specialtyId     String           @map("specialty_id") @db.Uuid
  name            String           @db.VarChar
  rangeYears      Json             @map("range_years") @db.Json
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @default(now()) @updatedAt @map("updated_at")
  createdBy       String           @map("created_by")
  updatedBy       String?          @map("updated_by")
  branch          Branch           @relation(fields: [branchId], references: [id])
  teacher         Teacher          @relation("room_teacher", fields: [teacherId], references: [userId])
  assistant       Teacher          @relation("room_assistant", fields: [assistantId], references: [userId])
  specialty       Specialty        @relation(fields: [specialtyId], references: [id])
  schedules       Schedule[]
  assignmentRooms AssignmentRoom[]

  @@map("rooms")
}

model AssignmentRoom {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inscriptionId       String               @map("inscription_id") @db.Uuid
  roomId              String               @map("room_id") @db.Uuid
  start               DateTime
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")
  createdBy           String               @map("created_by")
  updatedBy           String?              @map("updated_by")
  inscription         Inscription          @relation(fields: [inscriptionId], references: [id])
  room                Room                 @relation(fields: [roomId], references: [id])
  assignmentSchedules AssignmentSchedule[]

  @@unique([inscriptionId, roomId])
  @@map("assignment_rooms")
}

model Schedule {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roomId              String               @db.Uuid
  capacity            Int                  @db.Integer
  day                 DayOfWeek
  start               DateTime             @default(now())
  end                 DateTime             @default(now())
  color               String?              @db.VarChar
  active              Boolean              @default(true)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")
  createdBy           String               @map("created_by")
  updatedBy           String?              @map("updated_by")
  room                Room                 @relation(fields: [roomId], references: [id])
  assignmentSchedules AssignmentSchedule[]

  @@map("schedules")
}

model AssignmentSchedule {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assignmentRoomId String         @map("assignment_room_id") @db.Uuid
  scheduleId       String         @map("schedule_id") @db.Uuid
  day              DayOfWeek
  active           Boolean        @default(true)
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @default(now()) @updatedAt @map("updated_at")
  createdBy        String         @map("created_by")
  updatedBy        String?        @map("updated_by")
  assignmentRoom   AssignmentRoom @relation(fields: [assignmentRoomId], references: [id])
  schedule         Schedule       @relation(fields: [scheduleId], references: [id])
  sessions         Session[]

  @@map("assignment_schedules")
}

model Price {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inscriptionId    String       @map("inscription_id") @db.Uuid
  inscriptionPrice Float        @default(0.00) @map("inscription_price")
  monthPrice       Float        @default(0.00) @map("month_price")
  active           Boolean      @default(true)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at")
  createdBy        String       @map("created_by")
  updatedBy        String?      @map("updated_by")
  inscription      Inscription? @relation(fields: [inscriptionId], references: [id])

  @@map("prices")
}

model Inscription {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  studentId       String?          @map("student_id") @db.Uuid
  bookingId       String?          @unique @map("booking_id") @db.Uuid
  inscriptionType InscriptionType? @map("inscription_type")
  url             String?          @db.VarChar
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @default(now()) @updatedAt @map("updated_at")
  createdBy       String           @map("created_by")
  updatedBy       String?          @map("updated_by")
  student         Student?         @relation(fields: [studentId], references: [userId])
  booking         Booking?         @relation("booking_to_inscription", fields: [bookingId], references: [id])
  prices          Price[]
  assignmentRooms AssignmentRoom[]
  debts           Debts[]

  @@map("inscriptions")
}

model Booking {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  days        Int          @db.Integer
  dni         String       @db.VarChar
  name        String       @db.VarChar
  phone       Json
  amount      Float        @default(0.00)
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")
  createdBy   String       @map("created_by")
  updatedBy   String?      @map("updated_by")
  inscription Inscription? @relation("booking_to_inscription")

  @@map("bookings")
}

model Debts {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inscriptionId    String?      @map("inscription_id") @db.Uuid
  totalAmount      Float        @default(0.00) @map("total_amount")
  remainingBalance Float        @default(0.00) @map("remaining_balance")
  type             TypeDebt     @default(MONTH)
  dueDate          DateTime?    @map("due_date")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at")
  createdBy        String       @map("created_by")
  updatedBy        String?      @map("updated_by")
  inscription      Inscription? @relation(fields: [inscriptionId], references: [id])
  payments         Payment[]
  Refund           Refund?

  @@map("debts")
}

model Payment {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  debtId    String    @map("debt_id") @db.Uuid
  invoiceId String?   @map("invoice_id") @db.Uuid
  reference String?   @db.VarChar
  amount    Float     @default(0.00)
  payMethod PayMethod @default(CASH) @map("pay_method")
  active    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String    @map("created_by")
  updatedBy String?   @map("updated_by")
  debt      Debts     @relation(fields: [debtId], references: [id])
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

model Invoice {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code      String    @db.VarChar
  url       String?   @db.VarChar
  buyerNit  String    @map("buyer_nit") @db.VarChar
  buyerName String    @map("buyer_name") @db.VarChar
  active    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  createdBy String    @map("created_by")
  updatedBy String?   @map("updated_by")
  payments  Payment[]

  @@map("invoices")
}

model Refund {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  debtId    String   @unique @map("debt_id") @db.Uuid
  reference String?  @db.VarChar
  amount    Float    @default(0.00)
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")
  updatedBy String?  @map("updated_by")
  Debts     Debts    @relation(fields: [debtId], references: [id])

  @@map("refunds")
}

model Session {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assignmentScheduleId String             @map("assignment_schedule_id") @db.Uuid
  date                 DateTime?          @default(now())
  status               AttendanceStatus   @default(PENDING)
  observation          String?            @db.VarChar
  active               Boolean            @default(true)
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @default(now()) @updatedAt @map("updated_at")
  createdBy            String             @map("created_by")
  updatedBy            String?            @map("updated_by")
  assignmentSchedule   AssignmentSchedule @relation(fields: [assignmentScheduleId], references: [id])

  @@map("sessions")
}

model AccessRecord {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchId    String    @map("branch_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  checkIn     DateTime  @default(now()) @map("check_in")
  checkOut    DateTime? @map("check_out")
  observation String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  createdBy   String    @map("created_by")
  updatedBy   String?   @map("updated_by")
  branch      Branch    @relation(fields: [branchId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@map("access_records")
}

model Document {
  id            String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type          String
  data          Json
  createdAt     DateTime               @default(now()) @map("created_at")
  updatedAt     DateTime               @default(now()) @updatedAt @map("updated_at")
  createdBy     String                 @map("created_by")
  updatedBy     String?                @map("updated_by")
  transmissions DocumentTransmission[]

  @@map("documents")
}

model DocumentTransmission {
  id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId String             @map("document_id") @db.Uuid
  senderId   String             @map("sender_id") @db.Uuid
  receiverId String             @map("receiver_id") @db.Uuid
  status     TransmissionStatus @default(PENDING)
  createdAt  DateTime           @default(now()) @map("created_at")
  updatedAt  DateTime           @default(now()) @updatedAt @map("updated_at")
  readAt     DateTime?          @map("read_at")
  archivedAt DateTime?          @map("archived_at")
  createdBy  String             @map("created_by")
  updatedBy  String?            @map("updated_by")
  document   Document           @relation(fields: [documentId], references: [id])

  @@map("documentTransmissions")
}

// ENUMUS SECTIONS
enum TransmissionStatus {
  PENDING
  RECEIVED
  READ
  ARCHIVED
}

enum TypeDocument {
  DNI
  RUC
  PASAPORTE
}

enum InscriptionType {
  STUDENTS
  BOOKINGS
}

enum TypeDebt {
  BOOKING
  INSCRIPTION
  MONTH
  PER_SESSION
}

enum PayMethod {
  CASH
  BANK
  QR
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum Gender {
  MASCULINO
  FEMENINO
}

enum EducationLevel {
  PRIMARIA
  SECUNDARIA
}

enum AcademicStatus {
  ACTIVO
  INACTIVO
  EGRESADO
  TITULADO
  MAESTRIA
}

enum TypeAction {
  manage
  create
  read
  update
  delete
}

enum AttendanceStatus {
  PENDING
  PRESENT
  ABSENT
  LATE
  JUSTIFIED
}
